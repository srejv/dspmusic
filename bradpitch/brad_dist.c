
#include "brad_dist.h"
#include "qmath.h"
#include "definebrad.h"
#include "brad_input.h"
#include "tistdtypes.h"

volatile int *distActive = ((int*)DISTORTION_ACTIVE);

#define EXP_TABLE_SIZE	1024
#define EXP_POS_MAX		340778		// ska vara i fixt
#define EXP_NEG_MAX		-327670		// ska vara fixt
#define EXP_NEG_POS_MUL	(EXP_TABLE_SIZE/qabs(EXP_NEG_MAX))	// exponential negative position multiplier
#define EXP_POS_POS_MUL	(EXP_TABLE_SIZE/EXP_POS_MAX)

fixedp posExp[EXP_TABLE_SIZE] = {
	// Fill with data
32767, 33102, 33440, 33782, 
34127, 34476, 34828, 35184, 
35543, 35906, 36273, 36644, 
37018, 37397, 37779, 38165, 
38555, 38949, 39347, 39749, 
40155, 40565, 40980, 41398, 
41821, 42249, 42681, 43117, 
43557, 44002, 44452, 44906, 
45365, 45828, 46297, 46770, 
47248, 47730, 48218, 48711, 
49209, 49711, 50219, 50733, 
51251, 51775, 52304, 52838, 
53378, 53923, 54474, 55031, 
55593, 56161, 56735, 57315, 
57901, 58492, 59090, 59694, 
60304, 60920, 61542, 62171, 
62806, 63448, 64096, 64751, 
65413, 66081, 66757, 67439, 
68128, 68824, 69527, 70238, 
70955, 71680, 72413, 73153, 
73900, 74655, 75418, 76189, 
76967, 77754, 78548, 79351, 
80162, 80981, 81808, 82644, 
83489, 84342, 85204, 86074, 
86954, 87842, 88740, 89646, 
90562, 91488, 92423, 93367, 
94321, 95285, 96258, 97242, 
98236, 99239, 100253, 101278, 
102313, 103358, 104414, 105481, 
106559, 107648, 108748, 109859, 
110981, 112115, 113261, 114418, 
115588, 116769, 117962, 119167, 
120385, 121615, 122857, 124113, 
125381, 126662, 127956, 129264, 
130585, 131919, 133267, 134629, 
136004, 137394, 138798, 140216, 
141649, 143096, 144558, 146036, 
147528, 149035, 150558, 152096, 
153651, 155221, 156807, 158409, 
160027, 161663, 163315, 164983, 
166669, 168372, 170093, 171831, 
173586, 175360, 177152, 178962, 
180791, 182638, 184504, 186389, 
188294, 190218, 192162, 194125, 
196109, 198113, 200137, 202182, 
204248, 206335, 208443, 210573, 
212725, 214898, 217094, 219312, 
221553, 223817, 226104, 228414, 
230748, 233106, 235488, 237894, 
240325, 242781, 245262, 247768, 
250299, 252857, 255441, 258051, 
260687, 263351, 266042, 268761, 
271507, 274281, 277084, 279915, 
282775, 285664, 288583, 291532, 
294511, 297520, 300560, 303632, 
306734, 309868, 313034, 316233, 
319464, 322729, 326026, 329358, 
332723, 336123, 339557, 343027, 
346532, 350073, 353650, 357264, 
360914, 364602, 368327, 372091, 
375893, 379734, 383614, 387534, 
391494, 395494, 399535, 403618, 
407742, 411908, 416117, 420369, 
424664, 429003, 433387, 437815, 
442289, 446808, 451374, 455986, 
460645, 465352, 470107, 474911, 
479763, 484666, 489618, 494621, 
499675, 504781, 509938, 515149, 
520413, 525730, 531102, 536529, 
542011, 547550, 553145, 558797, 
564506, 570275, 576102, 581988, 
587935, 593943, 600011, 606142, 
612336, 618593, 624914, 631299, 
637750, 644266, 650849, 657500, 
664218, 671005, 677861, 684788, 
691785, 698854, 705995, 713209, 
720496, 727858, 735295, 742809, 
750399, 758066, 765812, 773637, 
781542, 789528, 797596, 805746, 
813979, 822296, 830698, 839186, 
847761, 856424, 865174, 874015, 
882946, 891968, 901082, 910289, 
919590, 928987, 938479, 948069, 
957756, 967542, 977429, 987416, 
997506, 1007698, 1017995, 1028397, 
1038905, 1049520, 1060244, 1071078, 
1082022, 1093078, 1104248, 1115531, 
1126929, 1138444, 1150077, 1161829, 
1173700, 1185693, 1197808, 1210048, 
1222412, 1234903, 1247521, 1260268, 
1273146, 1286155, 1299297, 1312573, 
1325985, 1339534, 1353221, 1367048, 
1381017, 1395128, 1409384, 1423785, 
1438333, 1453030, 1467877, 1482876, 
1498028, 1513335, 1528798, 1544419, 
1560200, 1576143, 1592248, 1608517, 
1624953, 1641557, 1658330, 1675275, 
1692393, 1709686, 1727156, 1744804, 
1762632, 1780643, 1798838, 1817218, 
1835787, 1854545, 1873495, 1892638, 
1911977, 1931514, 1951250, 1971188, 
1991330, 2011677, 2032232, 2052998, 
2073975, 2095167, 2116576, 2138203, 
2160051, 2182123, 2204420, 2226944, 
2249699, 2272687, 2295909, 2319369, 
2343068, 2367010, 2391196, 2415629, 
2440312, 2465248, 2490438, 2515885, 
2541592, 2567562, 2593798, 2620301, 
2647076, 2674124, 2701448, 2729051, 
2756937, 2785107, 2813566, 2842315, 
2871357, 2900697, 2930337, 2960279, 
2990527, 3021084, 3051954, 3083139, 
3114642, 3146468, 3178619, 3211098, 
3243909, 3277055, 3310540, 3344367, 
3378540, 3413062, 3447937, 3483168, 
3518759, 3554714, 3591036, 3627730, 
3664798, 3702245, 3740075, 3778291, 
3816897, 3855899, 3895298, 3935101, 
3975309, 4015929, 4056964, 4098418, 
4140296, 4182602, 4225340, 4268514, 
4312130, 4356192, 4400703, 4445670, 
4491096, 4536986, 4583345, 4630178, 
4677489, 4725284, 4773567, 4822343, 
4871618, 4921397, 4971684, 5022484, 
5073804, 5125648, 5178023, 5230932, 
5284382, 5338377, 5392925, 5448030, 
5503698, 5559935, 5616747, 5674139, 
5732118, 5790688, 5849858, 5909632, 
5970017, 6031018, 6092644, 6154898, 
6217789, 6281323, 6345506, 6410344, 
6475845, 6542016, 6608862, 6676392, 
6744611, 6813528, 6883149, 6953481, 
7024532, 7096309, 7168819, 7242070, 
7316070, 7390826, 7466345, 7542637, 
7619708, 7697566, 7776220, 7855678, 
7935947, 8017037, 8098955, 8181711, 
8265311, 8349767, 8435085, 8521275, 
8608345, 8696306, 8785165, 8874932, 
8965616, 9057227, 9149774, 9243267, 
9337715, 9433128, 9529516, 9626889, 
9725256, 9824629, 9925018, 10026432, 
10128882, 10232379, 10336934, 10442557, 
10549260, 10657052, 10765946, 10875953, 
10987084, 11099350, 11212764, 11327336, 
11443079, 11560005, 11678125, 11797453, 
11917999, 12039778, 12162801, 12287081, 
12412630, 12539463, 12667592, 12797029, 
12927790, 13059886, 13193333, 13328142, 
13464330, 13601909, 13740893, 13881298, 
14023138, 14166427, 14311180, 14457412, 
14605138, 14754374, 14905134, 15057435, 
15211293, 15366722, 15523740, 15682362, 
15842605, 16004485, 16168019, 16333224, 
16500118, 16668716, 16839038, 17011100, 
17184919, 17360515, 17537906, 17717109, 
17898142, 18081026, 18265779, 18452419, 
18640966, 18831440, 19023860, 19218247, 
19414619, 19612999, 19813405, 20015859, 
20220381, 20426994, 20635717, 20846574, 
21059585, 21274772, 21492158, 21711766, 
21933617, 22157736, 22384144, 22612866, 
22843925, 23077345, 23313150, 23551364, 
23792013, 24035120, 24280712, 24528813, 
24779449, 25032646, 25288430, 25546828, 
25807866, 26071572, 26337972, 26607094, 
26878966, 27153616, 27431073, 27711364, 
27994520, 28280568, 28569540, 28861465, 
29156372, 29454292, 29755257, 30059297, 
30366444, 30676729, 30990185, 31306844, 
31626738, 31949901, 32276366, 32606167, 
32939337, 33275913, 33615927, 33959415, 
34306414, 34656958, 35011083, 35368828, 
35730227, 36095320, 36464143, 36836734, 
37213133, 37593378, 37977508, 38365564, 
38757584, 39153610, 39553683, 39957844, 
40366134, 40778596, 41195273, 41616208, 
42041443, 42471024, 42904994, 43343399, 
43786283, 44233692, 44685674, 45142273, 
45603538, 46069516, 46540256, 47015806, 
47496215, 47981532, 48471809, 48967095, 
49467443, 49972902, 50483527, 50999369, 
51520482, 52046920, 52578737, 53115988, 
53658729, 54207015, 54760904, 55320452, 
55885718, 56456760, 57033637, 57616408, 
58205135, 58799876, 59400695, 60007653, 
60620813, 61240238, 61865993, 62498141, 
63136749, 63781882, 64433607, 65091992, 
65757104, 66429012, 67107785, 67793495, 
68486211, 69186005, 69892949, 70607117, 
71328583, 72057421, 72793705, 73537514, 
74288922, 75048008, 75814851, 76589529, 
77372123, 78162714, 78961383, 79768213, 
80583287, 81406689, 82238505, 83078820, 
83927722, 84785298, 85651637, 86526828, 
87410961, 88304129, 89206423, 90117937, 
91038765, 91969001, 92908743, 93858088, 
94817132, 95785976, 96764720, 97753465, 
98752313, 99761367, 100780731, 101810512, 
102850815, 103901747, 104963418, 106035937, 
107119416, 108213965, 109319698, 110436730, 
111565176, 112705152, 113856777, 115020169, 
116195448, 117382737, 118582157, 119793833, 
121017890, 122254454, 123503653, 124765617, 
126040476, 127328361, 128629406, 129943745, 
131271514, 132612850, 133967892, 135336780, 
136719655, 138116661, 139527941, 140953641, 
142393910, 143848895, 145318747, 146803618, 
148303662, 149819033, 151349888, 152896386, 
154458685, 156036949, 157631339, 159242020, 
160869160, 162512926, 164173488, 165851017, 
167545687, 169257674, 170987154, 172734306, 
174499310, 176282349, 178083607, 179903271, 
181741527, 183598568, 185474583, 187369768, 
189284318, 191218430, 193172306, 195146146, 
197140155, 199154539, 201189506, 203245266, 
205322032, 207420018, 209539442, 211680522, 
213843480, 216028539, 218235925, 220465866, 
222718592, 224994337, 227293336, 229615826, 
231962047, 234332242, 236726656, 239145536, 
241589132, 244057696, 246551485, 249070755, 
251615767, 254186785, 256784073, 259407900, 
262058537, 264736259, 267441342, 270174065, 
272934712, 275723566, 278540918, 281387057, 
284262278, 287166878, 290101158, 293065420, 
296059971, 299085120, 302141181, 305228468, 
308347301, 311498003, 314680899, 317896317, 
321144591, 324426056, 327741051, 331089918, 
334473005, 337890660, 341343236, 344831091, 
348354585, 351914083, 355509951, 359142562, 
362812291, 366519518, 370264625, 374047999, 
377870033, 381731120, 385631659, 389572055, 
393552713, 397574047, 401636470, 405740403, 
409886270, 414074500, 418305525, 422579783, 
426897716, 431259769, 435666394, 440118046, 
444615185, 449158275, 453747788, 458384196, 
463067979, 467799621, 472579611, 477408443, 
482286617, 487214635, 492193009, 497222251, 
502302882, 507435428, 512620418, 517858388, 
523149880, 528495441, 533895623, 539350984, 
544862088, 550429504, 556053809, 561735583, 
567475413, 573273894, 579131623, 585049207, 
591027257, 597066390, 603167232, 609330412, 
615556568, 621846343, 628200387, 634619357, 
641103916, 647654734, 654272489, 660957865, 
667711551, 674534247, 681426658, 688389495, 
695423479, 702529336, 709707802, 716959616, 
724285531, 731686301, 739162693, 746715479, 
754345439, 762053363, 769840046, 777706294, 
785652920, 793680744, 801790597, 809983317, 
818259750, 826620752, 835067187, 843599927, 
852219856, 860927863, 869724849, 878611723, 
887589403, 896658817, 905820903, 915076608, 
924426887, 933872708, 943415046, 953054889, 
962793231, 972631080, 982569453, 992609376, 
1002751888, 1012998035, 1023348879, 1033805487, 
1044368942, 1055040334, 1065820767, 1076711354

};

fixedp negExp[EXP_TABLE_SIZE] = {
	// Fill with data
	32767, 32448, 32133, 31820, 
31511, 31204, 30900, 30600, 
30302, 30007, 29716, 29426, 
29140, 28857, 28576, 28298, 
28023, 27750, 27480, 27213, 
26948, 26686, 26427, 26169, 
25915, 25663, 25413, 25166, 
24921, 24679, 24439, 24201, 
23966, 23732, 23502, 23273, 
23047, 22822, 22600, 22381, 
22163, 21947, 21734, 21522, 
21313, 21106, 20900, 20697, 
20496, 20296, 20099, 19903, 
19710, 19518, 19328, 19140, 
18954, 18770, 18587, 18406, 
18227, 18050, 17874, 17700, 
17528, 17358, 17189, 17022, 
16856, 16692, 16530, 16369, 
16210, 16052, 15896, 15741, 
15588, 15436, 15286, 15138, 
14990, 14845, 14700, 14557, 
14416, 14275, 14136, 13999, 
13863, 13728, 13594, 13462, 
13331, 13202, 13073, 12946, 
12820, 12695, 12572, 12449, 
12328, 12208, 12090, 11972, 
11856, 11740, 11626, 11513, 
11401, 11290, 11180, 11072, 
10964, 10857, 10752, 10647, 
10543, 10441, 10339, 10239, 
10139, 10040, 9943, 9846, 
9750, 9655, 9562, 9469, 
9376, 9285, 9195, 9105, 
9017, 8929, 8842, 8756, 
8671, 8587, 8503, 8421, 
8339, 8258, 8177, 8098, 
8019, 7941, 7864, 7787, 
7711, 7636, 7562, 7489, 
7416, 7344, 7272, 7201, 
7131, 7062, 6993, 6925, 
6858, 6791, 6725, 6660, 
6595, 6531, 6467, 6404, 
6342, 6280, 6219, 6159, 
6099, 6039, 5981, 5923, 
5865, 5808, 5751, 5695, 
5640, 5585, 5531, 5477, 
5424, 5371, 5319, 5267, 
5216, 5165, 5115, 5065, 
5016, 4967, 4919, 4871, 
4823, 4777, 4730, 4684, 
4638, 4593, 4549, 4504, 
4461, 4417, 4374, 4332, 
4290, 4248, 4207, 4166, 
4125, 4085, 4045, 4006, 
3967, 3928, 3890, 3852, 
3815, 3778, 3741, 3705, 
3669, 3633, 3597, 3562, 
3528, 3494, 3460, 3426, 
3393, 3360, 3327, 3295, 
3262, 3231, 3199, 3168, 
3137, 3107, 3077, 3047, 
3017, 2988, 2959, 2930, 
2901, 2873, 2845, 2818, 
2790, 2763, 2736, 2709, 
2683, 2657, 2631, 2606, 
2580, 2555, 2530, 2506, 
2481, 2457, 2433, 2410, 
2386, 2363, 2340, 2317, 
2295, 2272, 2250, 2228, 
2207, 2185, 2164, 2143, 
2122, 2101, 2081, 2061, 
2041, 2021, 2001, 1982, 
1962, 1943, 1924, 1906, 
1887, 1869, 1851, 1833, 
1815, 1797, 1780, 1762, 
1745, 1728, 1711, 1695, 
1678, 1662, 1646, 1630, 
1614, 1598, 1583, 1567, 
1552, 1537, 1522, 1507, 
1493, 1478, 1464, 1449, 
1435, 1421, 1408, 1394, 
1380, 1367, 1354, 1340, 
1327, 1314, 1302, 1289, 
1276, 1264, 1252, 1240, 
1227, 1216, 1204, 1192, 
1180, 1169, 1158, 1146, 
1135, 1124, 1113, 1102, 
1092, 1081, 1070, 1060, 
1050, 1040, 1029, 1019, 
1010, 1000, 990, 980, 
971, 961, 952, 943, 
934, 924, 915, 907, 
898, 889, 880, 872, 
863, 855, 847, 838, 
830, 822, 814, 806, 
798, 791, 783, 775, 
768, 760, 753, 746, 
738, 731, 724, 717, 
710, 703, 696, 690, 
683, 676, 670, 663, 
657, 650, 644, 638, 
631, 625, 619, 613, 
607, 601, 595, 590, 
584, 578, 573, 567, 
562, 556, 551, 545, 
540, 535, 530, 524, 
519, 514, 509, 504, 
499, 495, 490, 485, 
480, 476, 471, 466, 
462, 457, 453, 448, 
444, 440, 436, 431, 
427, 423, 419, 415, 
411, 407, 403, 399, 
395, 391, 387, 384, 
380, 376, 372, 369, 
365, 362, 358, 355, 
351, 348, 344, 341, 
338, 334, 331, 328, 
325, 322, 319, 315, 
312, 309, 306, 303, 
300, 297, 295, 292, 
289, 286, 283, 281, 
278, 275, 272, 270, 
267, 265, 262, 259, 
257, 254, 252, 249, 
247, 245, 242, 240, 
238, 235, 233, 231, 
228, 226, 224, 222, 
220, 218, 215, 213, 
211, 209, 207, 205, 
203, 201, 199, 197, 
195, 193, 192, 190, 
188, 186, 184, 182, 
181, 179, 177, 175, 
174, 172, 170, 169, 
167, 165, 164, 162, 
161, 159, 158, 156, 
155, 153, 152, 150, 
149, 147, 146, 144, 
143, 142, 140, 139, 
137, 136, 135, 133, 
132, 131, 130, 128, 
127, 126, 125, 123, 
122, 121, 120, 119, 
118, 116, 115, 114, 
113, 112, 111, 110, 
109, 108, 107, 106, 
105, 104, 102, 101, 
101, 100, 99, 98, 
97, 96, 95, 94, 
93, 92, 91, 90, 
89, 89, 88, 87, 
86, 85, 84, 83, 
83, 82, 81, 80, 
79, 79, 78, 77, 
76, 76, 75, 74, 
74, 73, 72, 71, 
71, 70, 69, 69, 
68, 67, 67, 66, 
65, 65, 64, 63, 
63, 62, 62, 61, 
60, 60, 59, 59, 
58, 58, 57, 56, 
56, 55, 55, 54, 
54, 53, 53, 52, 
52, 51, 51, 50, 
50, 49, 49, 48, 
48, 47, 47, 46, 
46, 46, 45, 45, 
44, 44, 43, 43, 
43, 42, 42, 41, 
41, 40, 40, 40, 
39, 39, 39, 38, 
38, 37, 37, 37, 
36, 36, 36, 35, 
35, 35, 34, 34, 
34, 33, 33, 33, 
32, 32, 32, 31, 
31, 31, 30, 30, 
30, 30, 29, 29, 
29, 28, 28, 28, 
28, 27, 27, 27, 
27, 26, 26, 26, 
26, 25, 25, 25, 
25, 24, 24, 24, 
24, 23, 23, 23, 
23, 23, 22, 22, 
22, 22, 21, 21, 
21, 21, 21, 20, 
20, 20, 20, 20, 
19, 19, 19, 19, 
19, 19, 18, 18, 
18, 18, 18, 17, 
17, 17, 17, 17, 
17, 16, 16, 16, 
16, 16, 16, 16, 
15, 15, 15, 15, 
15, 15, 15, 14, 
14, 14, 14, 14, 
14, 14, 13, 13, 
13, 13, 13, 13, 
13, 13, 12, 12, 
12, 12, 12, 12, 
12, 12, 11, 11, 
11, 11, 11, 11, 
11, 11, 11, 11, 
10, 10, 10, 10, 
10, 10, 10, 10, 
10, 10, 9, 9, 
9, 9, 9, 9, 
9, 9, 9, 9, 
9, 8, 8, 8, 
8, 8, 8, 8, 
8, 8, 8, 8, 
8, 8, 7, 7, 
7, 7, 7, 7, 
7, 7, 7, 7, 
7, 7, 7, 7, 
7, 6, 6, 6, 
6, 6, 6, 6, 
6, 6, 6, 6, 
6, 6, 6, 6, 
6, 6, 5, 5, 
5, 5, 5, 5, 
5, 5, 5, 5, 
5, 5, 5, 5, 
5, 5, 5, 5, 
5, 5, 4, 4, 
4, 4, 4, 4, 
4, 4, 4, 4, 
4, 4, 4, 4, 
4, 4, 4, 4, 
4, 4, 4, 4, 
4, 4, 4, 4, 
3, 3, 3, 3, 
3, 3, 3, 3, 
3, 3, 3, 3, 
3, 3, 3, 3, 
3, 3, 3, 3, 
3, 3, 3, 3, 
3, 3, 3, 3, 
3, 3, 3, 3, 
3, 3, 2, 2, 
2, 2, 2, 2, 
2, 2, 2, 2, 
2, 2, 2, 2, 
2, 2, 2, 2, 
2, 2, 2, 2, 
2, 2, 2, 2, 
2, 2, 2, 2, 
2, 2, 2, 2, 
2, 2, 2, 2, 
2, 2, 2, 2, 
2, 2, 2, 2, 
2, 2, 2, 2, 
2, 2, 2, 1
};

fixedp getExp(fixedp base) {
	Int32 pos;
	if (base > EXP_POS_MAX)
		return posExp[EXP_TABLE_SIZE-1];								
	else if (base < EXP_NEG_MAX)
		return negExp[EXP_TABLE_SIZE-1];
	else if (base > 0) {
		// måste anpassas till fixt tal så rätt element i tabellen anropas
		pos = q2int(qmul(base, EXP_POS_POS_MUL));
		if (pos < 0) {
			return posExp[0];
		}
		return posExp[pos];
	}
	else if (base < 0) {
		// samma här, VIKTIGT: LÄGG TILL AVRUNDNING, DERO HERO 
		pos = q2int(qmul(qabs(base), EXP_NEG_POS_MUL));
		if(pos < 0) {
			return negExp[0];
		}
		return negExp[pos];
	}
	
	return 1;
}

void process_dist(Distortion *t, fixedp *x) {
	if(*(distActive)) {
		t->gain = (*((int*)(DISTORTION_GAIN)))*3500;
		t->lvl1 = (*((int*)(DISTORTION_LVL1)))*3500;
		t->lvl2 = (*((int*)(DISTORTION_LVL2)))*3500;
		t->fdb = (*((int*)(DISTORTION_FDB)))*3500;
		process_fuzz(t, x);
		/*switch(*((int*)DISTORTION_TYPE))) {
			case 0:
				process_fuzz(t, x);
				break;
			case 1:
				process_thunderFuzz(t, x);
				break;
			case 2:
				process_squareDist(t, x);
				break;
			case 3:
				process_overdrive(t, x);
				break;
		}*/
	}
}
void process_fuzz(Distortion *t, fixedp *x) { 
	Uint32 n;
	
	if(t->fdb != 0) {
	
		for(n = 0; n < PROCESS_SIZE; n++) {
			t->prev = qadd(qmul(x[n], t->gain), qmul(t->prev, t->fdb));

			if (t->prev > t->lvl1)
				t->prev = t->lvl1;
			else if (t->prev < -t->lvl2)
				t->prev = -t->lvl2;

			x[n] = t->prev;
		}

	}
	else {
		for(n = 0; n < PROCESS_SIZE; n++) {
			t->prev = qmul(x[n], t->gain);

			if (t->prev > t->lvl1)
				t->prev = t->lvl1;
			else if (t->prev < -t->lvl2)
				t->prev = -t->lvl2;

			x[n] = t->prev;
		}
	}
}

void process_squareDist(Distortion *t, fixedp *x) { 
	Uint32 n;
	
	if(t->fdb != 0) {
	
		for(n = 0; n < PROCESS_SIZE; n++) {
			t->prev = qadd(qmul(x[n], t->gain), qmul(t->prev, t->fdb));

			if (t->prev > 0)
				t->prev = t->lvl1;
			else if (t->prev < 0)
				t->prev = -t->lvl2;

			x[n] = t->prev;
		}

	}
	else {
		for(n = 0; n < PROCESS_SIZE; n++) {
			t->prev = qmul(x[n], t->gain);

			if (t->prev > 0)
				t->prev = t->lvl1;
			else if (t->prev < 0)
				t->prev = -t->lvl2;

			x[n] = t->prev;
		}
	}
}


void process_thunderFuzz( Distortion *t, fixedp *x ) {
	Uint32 n;
	
	// remember to keep sample from previous cycle. :) keep in structure. disttruc
	if(t->fdb) {
		for(n=0; n < PROCESS_SIZE; n++) {
			t->prev = qadd(qmul(x[n],t->gain), qmul(t->prev, t->fdb));
		
			if (t->prev > t->lvl1) 
				t->prev = t->lvl1;
			else if (t->prev < -t->lvl2)
				t->prev = -t->lvl2;

			x[n] = qabs(t->prev);
		}
	}
	else {
		for(n=0; n < PROCESS_SIZE; n++) {
			t->prev = qmul(x[n],t->gain);

			if (t->prev > t->lvl1) 
				t->prev = t->lvl1;
			else if (t->prev < -t->lvl2)
				t->prev = -t->lvl2;
			

			x[n] = qabs(t->prev);
		}
	}
}

void process_overdrive(Distortion *t, fixedp *x) {
	
	Uint32 n;
	fixedp denom, tmp, a, b, numerator, denom1, denom2;

	// kom ihåg förra processens sampel?
	/*if(t->fdb) {
		for(n = 0; n < PROCESS_SIZE; n++) {
			t->prev = qadd( qmul( x[n],t->gain ), qmul( qmul(t->prev, t->gain), t->fdb ) );
			
	
			// 6554 = 0.2
			numeratorLvl1 = qmul(t->lvl1, qexp(qmul(t->prev, qadd(Q1, qmul(6554, qsub(Q1, t->lvl1))))));
			numeratorLvl2 = qmul(t->lvl2, qexp(qmul(-t->prev, qadd(Q1, qmul(6554, qsub(Q1, t->lvl2))))));
			denom = qadd(qexp(t->prev), qexp(-t->prev));
			x[n] = qdiv(qsub(numeratorLvl1, numeratorLvl2), denom);
		}
	} 
	else {*/
		for(n = 0; n < PROCESS_SIZE; n++) {

			t->prev = qmul(x[n],t->gain);
			


			a = qadd(Q1,qmul(3254,qsub(Q1,t->lvl1)));
			b = qadd(Q1,qmul(3254,qsub(Q1,t->lvl2)));
			tmp = qmul(-t->prev, qadd(a,b));
			
			if(tmp > short2q(32)) tmp = short2q(32);
			if(tmp < short2q(-32)) tmp = short2q(-32);
			
			tmp = qexp(tmp);
			numerator = qsub(t->lvl1, qmul(t->lvl2, tmp));
			
			tmp = qmul(t->prev, qsub(Q1, a));

			if(tmp > short2q(32)) tmp = short2q(32);
			if(tmp < short2q(-32)) tmp = short2q(-32);
			denom1 = qexp(tmp);

			tmp = qmul(-t->prev, qadd(Q1, a));

			if(tmp > short2q(32)) tmp = short2q(32);
			if(tmp < short2q(-32)) tmp = short2q(-32);
			denom2 = qexp(tmp);
			
			denom = qadd(denom1, denom2);
			tmp = qdiv(numerator, denom);
			
			if (tmp > AUDIOMAX) {
				// nu är tmp större än 32767
				tmp = AUDIOMAX;
			} else if (tmp < AUDIOMIN) {
				tmp = AUDIOMIN;
			}

			x[n] = tmp;
		}
	//}
}


void dist_setParam(Distortion *t, Uint32 param, int val) {
	switch(param) {

	case DISTORTION_FDB:
		t->fdb = val*255;
		break;
	case DISTORTION_GAIN:
		t->gain = val*255;
		break;
	case DISTORTION_LVL1:
		t->lvl1 = val*255;
		break;
	case DISTORTION_LVL2:
		t->lvl2 = val*255;
		break;
	}
}
